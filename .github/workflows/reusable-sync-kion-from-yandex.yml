name: Reusable — Sync Kion Music from Yandex Music

on:
  workflow_call:
    inputs:
      kion_repo:
        description: "Target kion provider repository (owner/repo)"
        default: "trudenboy/ma-provider-kion-music"
        type: string
      kion_branch:
        description: "Base branch in kion repo to target for the PR"
        default: "dev"
        type: string
      yandex_provider_path:
        description: "Path to provider source inside the yandex repo (e.g. provider/)"
        default: "provider/"
        type: string
    secrets:
      FORK_SYNC_PAT:
        required: true

jobs:
  sync:
    name: Sync branding Yandex → Kion and open PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Yandex Music provider repo
        uses: actions/checkout@v4
        with:
          path: yandex-repo

      - name: Checkout Kion Music provider repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.kion_repo }}
          token: ${{ secrets.FORK_SYNC_PAT }}
          ref: ${{ inputs.kion_branch }}
          path: kion-repo

      - name: Resolve version tag
        id: tag
        run: |
          VERSION=$(gh release view --repo "${{ github.repository }}" --json tagName -q .tagName 2>/dev/null || echo "")
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy provider files and apply branding substitutions
        id: sync
        run: |
          set -euo pipefail

          rsync -av --delete \
            --exclude="*.svg" \
            --exclude="*.png" \
            --exclude="*.jpg" \
            --exclude="*.jpeg" \
            --exclude="*.ico" \
            --exclude="*.webp" \
            yandex-repo/${{ inputs.yandex_provider_path }} \
            kion-repo/${{ inputs.yandex_provider_path }}

          # Apply branding substitutions: Yandex → Kion (identifiers, class names, display strings)
          find kion-repo/${{ inputs.yandex_provider_path }} -type f -name "*.py" | while read -r f; do
            sed -i \
              -e '/\(from\|import\) yandex_music/!s/yandex_music/kion_music/g' \
              -e 's/YandexMusic/KionMusic/g' \
              -e 's/Yandex Music/KION Music/g' \
              -e 's/Яндекс Музыка/KION Music/g' \
              -e 's/Яндекс\.Музыка/KION Music/g' \
              -e '/http/!s/\bYandex\b/Kion/g' \
              -e '/http/!s/\byandex\b/kion/g' \
              -e 's/My Wave/My Mix/g' \
              -e 's/my wave/my mix/g' \
              -e 's/AI Wave Sets/AI Mix Sets/g' \
              -e 's/Featured Waves/Featured Mixes/g' \
              -e 's/Моя волна/Мой микс/g' \
              -e 's/Избранные волны/Избранные миксы/g' \
              "$f"
          done

          # Restore manifest domain if it was overwritten
          if [ -f "kion-repo/${{ inputs.yandex_provider_path }}manifest.json" ]; then
            python3 - <<'EOF'
          import json, pathlib
          p = pathlib.Path("kion-repo/${{ inputs.yandex_provider_path }}manifest.json")
          m = json.loads(p.read_text())
          m["domain"] = "kion_music"
          m["name"] = "KION Music"
          p.write_text(json.dumps(m, indent=2, ensure_ascii=False) + "\n")
          EOF
          fi

          # Override DEFAULT_BASE_URL in kion's constants.py
          if [ -f "kion-repo/${{ inputs.yandex_provider_path }}constants.py" ]; then
            python3 - <<'EOF'
          import re, pathlib
          p = pathlib.Path("kion-repo/${{ inputs.yandex_provider_path }}constants.py")
          content = p.read_text()
          content = re.sub(
              r'(DEFAULT_BASE_URL: Final\[str\] = ")[^"]*(")',
              r'\1https://music.mts.ru/ya_proxy_api\2',
              content
          )
          p.write_text(content)
          EOF
          fi

          # Check if anything changed vs HEAD
          cd kion-repo
          git diff --quiet && echo "sync_made_changes=false" >> $GITHUB_OUTPUT \
                           || echo "sync_made_changes=true"  >> $GITHUB_OUTPUT

      - name: Create PR in Kion Music provider repo
        if: steps.sync.outputs.sync_made_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.FORK_SYNC_PAT }}
        run: |
          VERSION="${{ steps.tag.outputs.version }}"
          BRANCH="auto-sync/kion-from-yandex-${{ github.run_number }}"
          TARGET="${{ inputs.kion_branch }}"

          cd kion-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "feat(kion_music): sync branding from yandex_music ${VERSION}"
          git push origin "$BRANCH"

          BODY=$(printf '## Auto-sync from Yandex Music %s\n\n**Source**: [%s](%s/releases/tag/%s)\n\n### Applied substitutions\n- `yandex_music` → `kion_music`\n- `YandexMusic` → `KionMusic`\n- Display strings: "Yandex Music" / "Яндекс Музыка" → "KION Music"\n- `manifest.json` domain/name fixed to `kion_music` / "KION Music"\n- API endpoints (`music.mts.ru/ya_api`) left untouched\n\n### Review checklist\n- [ ] API endpoint not accidentally changed (must be `music.mts.ru/ya_api`)\n- [ ] Kion-specific feature flags / settings preserved\n- [ ] No unintended regressions\n\nAuto-generated by `reusable-sync-kion-from-yandex.yml`' \
            "$VERSION" \
            "${{ github.event.repository.name }}" \
            "https://github.com/${{ github.repository }}" \
            "$VERSION")

          gh pr create \
            --repo "${{ inputs.kion_repo }}" \
            --base "$TARGET" \
            --head "$BRANCH" \
            --title "feat(kion_music): sync branding from yandex_music ${VERSION}" \
            --body "$BODY" \
            --label "auto-sync" || \
          gh pr create \
            --repo "${{ inputs.kion_repo }}" \
            --base "$TARGET" \
            --head "$BRANCH" \
            --title "feat(kion_music): sync branding from yandex_music ${VERSION}" \
            --body "$BODY"

  # ─── Report sync failure as a GitHub issue (with dedup) ─────────────────────
  report-failure:
    needs: [sync]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Create or update sync incident issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TITLE: "Kion sync failure — ${{ github.ref_name }}"
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          LABEL="incident:ci"
          EXISTING=$(gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --label "$LABEL" \
            --state open \
            --json number,title \
            --jq ".[] | select(.title == \"$TITLE\") | .number" \
            | head -1)

          if [[ -n "$EXISTING" ]]; then
            gh issue comment "$EXISTING" \
              --repo "$GITHUB_REPOSITORY" \
              --body "New Kion sync failure on \`${{ github.ref_name }}\`: $RUN_URL"
          else
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$(printf 'Kion Music sync failed on branch \`%s\`.\n\n**Run:** %s' "${{ github.ref_name }}" "$RUN_URL")" \
              --label "$LABEL" --label "priority:high" || \
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$(printf 'Kion Music sync failed on branch \`%s\`.\n\n**Run:** %s' "${{ github.ref_name }}" "$RUN_URL")"
          fi
