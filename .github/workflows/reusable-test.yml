name: Reusable — Test Provider

on:
  workflow_call:
    inputs:
      provider_type:
        description: "Provider type: music_provider or player_provider"
        required: true
        type: string
      provider_domain:
        description: "Provider domain slug (e.g. msx_bridge) — required for player_provider symlink"
        default: ""
        type: string
      provider_path:
        description: "Relative path to provider source inside repo (e.g. provider/) — required for player_provider"
        default: ""
        type: string
      manifest_path:
        description: "Path to manifest.json inside the provider repo"
        default: "provider/manifest.json"
        type: string

jobs:
  # ─── Music provider: install from upstream ma-server, run pytest + codecov ───
  test-music-provider:
    if: ${{ inputs.provider_type == 'music_provider' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.13"
      - name: Install deps
        run: |
          uv pip install \
            "git+https://github.com/music-assistant/server.git@dev" \
            -e ".[test]"
      - name: Pytest
        run: pytest --durations 10 --tb=short --cov=provider --cov-report=xml tests/
      - uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml

  lint-music-provider:
    if: ${{ inputs.provider_type == 'music_provider' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
      - run: uv pip install -e ".[test]"
      - run: SKIP=no-commit-to-branch pre-commit run --all-files

  # ─── Player provider: clone fork ma-server, symlink, pre-commit + mypy + pytest ────
  test-player-provider:
    if: ${{ inputs.provider_type == 'player_provider' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/checkout@v4
        with:
          repository: trudenboy/ma-server
          ref: dev
          path: ma-server
          fetch-depth: 1
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.13"
      - name: Install dependencies
        working-directory: ma-server
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e "." -e ".[test]" -r requirements_all.txt
      - name: Symlink provider
        run: |
          rm -rf "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
          ln -s "$GITHUB_WORKSPACE/${{ inputs.provider_path }}" \
                "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
      - name: Run unit tests
        run: |
          source ma-server/.venv/bin/activate
          pytest tests/ -v --ignore=tests/integration --tb=short -p no:cacheprovider \
            --cov=${{ inputs.provider_path }} --cov-report=xml
        env:
          PYTHONDONTWRITEBYTECODE: "1"
      - uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml

  lint-player-provider:
    if: ${{ inputs.provider_type == 'player_provider' }}
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/checkout@v4
        with:
          repository: trudenboy/ma-server
          ref: dev
          path: ma-server
          fetch-depth: 1
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ma-server
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e "." -e ".[test]" -r requirements_all.txt
      - name: Symlink provider
        run: |
          rm -rf "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
          ln -s "$GITHUB_WORKSPACE/${{ inputs.provider_path }}" \
                "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
      - name: Lint (pre-commit)
        run: |
          source ma-server/.venv/bin/activate
          SKIP=no-commit-to-branch,mypy pre-commit run --all-files
      - name: Type check
        run: |
          source ma-server/.venv/bin/activate
          mypy ${{ inputs.provider_path }} --ignore-missing-imports

  check-manifest-safety:
    name: Check Manifest Package Safety
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Extract packages from manifest
        id: pkgs
        run: |
          python3 - <<'PYEOF'
          import json, re, os
          manifest = json.load(open("${{ inputs.manifest_path }}"))
          reqs = manifest.get("requirements", [])
          packages = [re.match(r"^([A-Za-z0-9_-]+)", r).group(1) for r in reqs if re.match(r"^([A-Za-z0-9_-]+)", r)]
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("packages=" + " ".join(packages) + "\n")
          PYEOF
      - name: Download check_package_safety.py
        run: curl -fsSL https://raw.githubusercontent.com/trudenboy/ma-provider-tools/main/scripts/check_package_safety.py -o check_package_safety.py
      - name: Run safety check
        run: |
          [ -z "${{ steps.pkgs.outputs.packages }}" ] && echo "No requirements to check" && exit 0
          python3 check_package_safety.py ${{ steps.pkgs.outputs.packages }}

  diff-manifest-deps:
    name: Diff Manifest Dependencies
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Get old manifest from base branch
        run: git show origin/${{ github.base_ref }}:${{ inputs.manifest_path }} > /tmp/old_manifest.json 2>/dev/null || echo '{}' > /tmp/old_manifest.json
      - name: Download parse_manifest_deps.py
        run: curl -fsSL https://raw.githubusercontent.com/trudenboy/ma-provider-tools/main/scripts/parse_manifest_deps.py -o parse_manifest_deps.py
      - name: Generate dependency diff
        id: diff
        run: |
          OUTPUT=$(python3 parse_manifest_deps.py /tmp/old_manifest.json "${{ inputs.manifest_path }}" || true)
          echo "diff_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - name: Post diff to GitHub step summary
        run: echo "${{ steps.diff.outputs.diff_output }}" >> $GITHUB_STEP_SUMMARY
      - name: Comment on PR
        if: ${{ steps.diff.outputs.diff_output != '' }}
        uses: actions/github-script@v7
        env:
          DIFF_OUTPUT: ${{ steps.diff.outputs.diff_output }}
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Manifest Dependency Changes\n\n${process.env.DIFF_OUTPUT}`,
            });
