name: Reusable — Test Provider

on:
  workflow_call:
    inputs:
      provider_type:
        description: "Provider type: music_provider or player_provider"
        required: true
        type: string
      provider_domain:
        description: "Provider domain slug (e.g. msx_bridge) — required for symlink"
        default: ""
        type: string
      provider_path:
        description: "Relative path to provider source inside repo (e.g. provider/) — required for symlink and coverage"
        default: ""
        type: string
      manifest_path:
        description: "Path to manifest.json inside the provider repo"
        default: "provider/manifest.json"
        type: string

jobs:
  # ─── Music provider: clone upstream ma-server, symlink, run pytest + codecov ───
  test-music-provider:
    if: ${{ inputs.provider_type == 'music_provider' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/checkout@v4
        with:
          repository: music-assistant/server
          ref: dev
          path: ma-server
          fetch-depth: 1
      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ma-server
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e "." -e ".[test]" -r requirements_all.txt
      - name: Install provider dependencies
        working-directory: ${{ github.workspace }}
        run: |
          source ma-server/.venv/bin/activate
          python3 << 'PYEOF'
          import tomllib, subprocess, sys
          try:
              with open("pyproject.toml", "rb") as f:
                  d = tomllib.load(f)
          except FileNotFoundError:
              sys.exit(0)
          deps = d.get("project", {}).get("dependencies", [])
          if deps:
              subprocess.run(["uv", "pip", "install", "--"] + deps, check=True)
          PYEOF
      - name: Symlink provider
        run: |
          rm -rf "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
          ln -s "$GITHUB_WORKSPACE/${{ inputs.provider_path }}" \
                "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
      - name: Run unit tests
        working-directory: ma-server
        run: |
          source .venv/bin/activate
          pytest --durations 10 --cov-report term-missing \
            --cov=music_assistant/providers/${{ inputs.provider_domain }} \
            --cov-report=xml:${{ github.workspace }}/coverage.xml \
            ${{ github.workspace }}/tests/ \
            --ignore=${{ github.workspace }}/tests/integration \
            --ignore=${{ github.workspace }}/tests/test_integration.py
        env:
          PYTHONDONTWRITEBYTECODE: "1"
      - uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml

  lint-music-provider:
    if: ${{ inputs.provider_type == 'music_provider' }}
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/checkout@v4
        with:
          repository: music-assistant/server
          ref: dev
          path: ma-server
          fetch-depth: 1
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ma-server
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e "." -e ".[test]" -r requirements_all.txt
      - name: Install provider dependencies
        working-directory: ${{ github.workspace }}
        run: |
          source ma-server/.venv/bin/activate
          python3 << 'PYEOF'
          import tomllib, subprocess, sys
          try:
              with open("pyproject.toml", "rb") as f:
                  d = tomllib.load(f)
          except FileNotFoundError:
              sys.exit(0)
          deps = d.get("project", {}).get("dependencies", [])
          if deps:
              subprocess.run(["uv", "pip", "install", "--"] + deps, check=True)
          PYEOF
      - name: Symlink provider
        run: |
          rm -rf "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
          ln -s "$GITHUB_WORKSPACE/${{ inputs.provider_path }}" \
                "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
      - name: Lint (pre-commit)
        run: |
          source ma-server/.venv/bin/activate
          SKIP=no-commit-to-branch,mypy pre-commit run --all-files
      - name: Type check
        working-directory: ma-server
        run: |
          source .venv/bin/activate
          mypy music_assistant/providers/${{ inputs.provider_domain }}

  # ─── Player provider: clone fork ma-server, symlink, pre-commit + mypy + pytest ────
  test-player-provider:
    if: ${{ inputs.provider_type == 'player_provider' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/checkout@v4
        with:
          repository: trudenboy/ma-server
          ref: dev
          path: ma-server
          fetch-depth: 1
      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ma-server
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e "." -e ".[test]" -r requirements_all.txt
      - name: Install provider dependencies
        working-directory: ${{ github.workspace }}
        run: |
          source ma-server/.venv/bin/activate
          python3 << 'PYEOF'
          import tomllib, subprocess, sys
          try:
              with open("pyproject.toml", "rb") as f:
                  d = tomllib.load(f)
          except FileNotFoundError:
              sys.exit(0)
          deps = d.get("project", {}).get("dependencies", [])
          if deps:
              subprocess.run(["uv", "pip", "install", "--"] + deps, check=True)
          PYEOF
      - name: Symlink provider
        run: |
          rm -rf "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
          ln -s "$GITHUB_WORKSPACE/${{ inputs.provider_path }}" \
                "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
      - name: Run unit tests
        working-directory: ma-server
        run: |
          source .venv/bin/activate
          pytest --durations 10 --cov-report term-missing \
            --cov=music_assistant/providers/${{ inputs.provider_domain }} \
            --cov-report=xml:${{ github.workspace }}/coverage.xml \
            ${{ github.workspace }}/tests/ \
            --ignore=${{ github.workspace }}/tests/integration \
            --ignore=${{ github.workspace }}/tests/test_integration.py
        env:
          PYTHONDONTWRITEBYTECODE: "1"
      - uses: codecov/codecov-action@v5
        with:
          file: ./coverage.xml

  lint-player-provider:
    if: ${{ inputs.provider_type == 'player_provider' }}
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - uses: actions/checkout@v4
        with:
          repository: trudenboy/ma-server
          ref: dev
          path: ma-server
          fetch-depth: 1
      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          python-version: "3.12"
      - name: Install dependencies
        working-directory: ma-server
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e "." -e ".[test]" -r requirements_all.txt
      - name: Install provider dependencies
        working-directory: ${{ github.workspace }}
        run: |
          source ma-server/.venv/bin/activate
          python3 << 'PYEOF'
          import tomllib, subprocess, sys
          try:
              with open("pyproject.toml", "rb") as f:
                  d = tomllib.load(f)
          except FileNotFoundError:
              sys.exit(0)
          deps = d.get("project", {}).get("dependencies", [])
          if deps:
              subprocess.run(["uv", "pip", "install", "--"] + deps, check=True)
          PYEOF
      - name: Symlink provider
        run: |
          rm -rf "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
          ln -s "$GITHUB_WORKSPACE/${{ inputs.provider_path }}" \
                "$GITHUB_WORKSPACE/ma-server/music_assistant/providers/${{ inputs.provider_domain }}"
      - name: Lint (pre-commit)
        run: |
          source ma-server/.venv/bin/activate
          SKIP=no-commit-to-branch,mypy pre-commit run --all-files
      - name: Type check
        working-directory: ma-server
        run: |
          source .venv/bin/activate
          mypy music_assistant/providers/${{ inputs.provider_domain }}

  # ─── Report CI failure as a GitHub issue (with dedup) ────────────────────────
  # Split into two jobs to avoid GitHub startup_failure: when all needs-jobs are
  # conditional, GitHub fails the entire reusable workflow at startup because it
  # cannot resolve the dependency graph (2 of 4 jobs are always skipped).
  report-failure-music:
    needs: [test-music-provider, lint-music-provider]
    if: >-
      ${{ always() &&
          inputs.provider_type == 'music_provider' &&
          (needs.test-music-provider.result == 'failure' ||
           needs.lint-music-provider.result == 'failure') }}
    runs-on: ubuntu-latest
    steps:
      - name: Create or update CI incident issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TITLE: "CI test failure — ${{ github.ref_name }}"
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          LABEL="incident:ci"
          EXISTING=$(gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --label "$LABEL" \
            --state open \
            --json number,title \
            --jq ".[] | select(.title == \"$TITLE\") | .number" \
            | head -1)

          if [[ -n "$EXISTING" ]]; then
            gh issue comment "$EXISTING" \
              --repo "$GITHUB_REPOSITORY" \
              --body "New failure on \`${{ github.ref_name }}\`: $RUN_URL"
          else
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$(printf 'Tests failed on branch \`%s\`.\n\n**Run:** %s' "${{ github.ref_name }}" "$RUN_URL")" \
              --label "$LABEL" --label "priority:high" || \
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$(printf 'Tests failed on branch \`%s\`.\n\n**Run:** %s' "${{ github.ref_name }}" "$RUN_URL")"
          fi

  report-failure-player:
    needs: [test-player-provider, lint-player-provider]
    if: >-
      ${{ always() &&
          inputs.provider_type == 'player_provider' &&
          (needs.test-player-provider.result == 'failure' ||
           needs.lint-player-provider.result == 'failure') }}
    runs-on: ubuntu-latest
    steps:
      - name: Create or update CI incident issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TITLE: "CI test failure — ${{ github.ref_name }}"
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: |
          LABEL="incident:ci"
          EXISTING=$(gh issue list \
            --repo "$GITHUB_REPOSITORY" \
            --label "$LABEL" \
            --state open \
            --json number,title \
            --jq ".[] | select(.title == \"$TITLE\") | .number" \
            | head -1)

          if [[ -n "$EXISTING" ]]; then
            gh issue comment "$EXISTING" \
              --repo "$GITHUB_REPOSITORY" \
              --body "New failure on \`${{ github.ref_name }}\`: $RUN_URL"
          else
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$(printf 'Tests failed on branch \`%s\`.\n\n**Run:** %s' "${{ github.ref_name }}" "$RUN_URL")" \
              --label "$LABEL" --label "priority:high" || \
            gh issue create \
              --repo "$GITHUB_REPOSITORY" \
              --title "$TITLE" \
              --body "$(printf 'Tests failed on branch \`%s\`.\n\n**Run:** %s' "${{ github.ref_name }}" "$RUN_URL")"
          fi
