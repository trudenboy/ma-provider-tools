name: Submit Provider to Upstream

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Provider domain to submit"
        required: true
        type: choice
        options:{% for p in all_providers %}
          - {{ p.domain }}{% endfor %}
      version:
        description: "Provider release version (e.g. 1.2.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  create-upstream-pr:
    name: Create/update draft PR to upstream
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve domain and clone provider release
        env:
          GH_TOKEN: {% raw %}${{ secrets.FORK_SYNC_PAT }}{% endraw %}
        run: |
          case "{% raw %}${{ inputs.domain }}{% endraw %}" in{% for p in all_providers %}
            {{ p.domain }}) PROVIDER_REPO="{{ p.repo }}"; PROVIDER_PATH="{{ p.provider_path }}" ;;{% endfor %}
            *) echo "Unknown domain: {% raw %}${{ inputs.domain }}{% endraw %}"; exit 1 ;;
          esac
          echo "PROVIDER_REPO=$PROVIDER_REPO" >> $GITHUB_ENV
          echo "PROVIDER_PATH=$PROVIDER_PATH" >> $GITHUB_ENV

          gh repo clone "$PROVIDER_REPO" provider-repo -- \
            --depth 1 --branch "v{% raw %}${{ inputs.version }}{% endraw %}"

      - name: Prepare upstream/<domain> branch and create/update draft PR
        env:
          GH_TOKEN: {% raw %}${{ secrets.FORK_SYNC_PAT }}{% endraw %}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote add upstream https://github.com/music-assistant/server.git
          git fetch upstream dev

          DOMAIN="{% raw %}${{ inputs.domain }}{% endraw %}"
          VERSION="v{% raw %}${{ inputs.version }}{% endraw %}"
          # Branch name has no version — one branch/PR per domain, updated on each run
          BRANCH="upstream/${DOMAIN}"

          git checkout -B "$BRANCH" upstream/dev

          DEST="music_assistant/providers/${DOMAIN}"
          mkdir -p "$DEST"
          rsync -av --delete "provider-repo/${PROVIDER_PATH}" "$DEST/"

          if [ -d "provider-repo/tests" ]; then
            mkdir -p "tests/providers/${DOMAIN}"
            rsync -av --delete provider-repo/tests/ "tests/providers/${DOMAIN}/"
          fi

          git add -A
          if git diff --cached --quiet; then
            echo "No changes vs upstream/dev — nothing to submit"
            exit 0
          fi

          git commit -m "feat(${DOMAIN}): add ${DOMAIN} provider ${VERSION}"
          git push origin "$BRANCH" --force

          PR_BODY=$(printf '## Add %s provider %s\n\n**Source**: [%s %s](https://github.com/%s/releases/tag/%s)\n\nProvider code taken from the release tag. This is a draft PR — please review before requesting merge into upstream.' \
            "$DOMAIN" "$VERSION" "$PROVIDER_REPO" "$VERSION" "$PROVIDER_REPO" "$VERSION")

          EXISTING_PR=$(gh pr list \
            --repo music-assistant/server \
            --head "trudenboy:${BRANCH}" \
            --json number --jq '.[0].number' 2>/dev/null || true)

          if [[ -n "$EXISTING_PR" ]]; then
            echo "PR #${EXISTING_PR} already exists — updating title and body"
            gh pr edit "$EXISTING_PR" \
              --repo music-assistant/server \
              --title "feat(${DOMAIN}): add ${DOMAIN} provider ${VERSION}" \
              --body "$PR_BODY"
          else
            gh pr create \
              --draft \
              --repo music-assistant/server \
              --head "trudenboy:${BRANCH}" \
              --base dev \
              --title "feat(${DOMAIN}): add ${DOMAIN} provider ${VERSION}" \
              --body "$PR_BODY"
          fi

      - name: Update integration/pending-upstream
        env:
          GH_TOKEN: {% raw %}${{ secrets.FORK_SYNC_PAT }}{% endraw %}
        run: |
          DOMAIN="{% raw %}${{ inputs.domain }}{% endraw %}"
          DOMAINS="{{ all_providers | map(attribute='domain') | join(' ') }}"

          git fetch origin

          # Rebuild integration/pending-upstream = upstream/dev + all active upstream/<domain> branches
          git remote add upstream https://github.com/music-assistant/server.git 2>/dev/null || true
          git fetch upstream dev

          git checkout -B integration/pending-upstream upstream/dev

          for domain in $DOMAINS; do
            if git ls-remote --heads origin "upstream/${domain}" | grep -q .; then
              git checkout "origin/upstream/${domain}" -- "music_assistant/providers/${domain}/" 2>/dev/null || true
            fi
          done

          git add -A
          if ! git diff --cached --quiet; then
            git commit -m "chore: rebuild integration/pending-upstream after ${DOMAIN} update"
          fi
          git push origin integration/pending-upstream --force
