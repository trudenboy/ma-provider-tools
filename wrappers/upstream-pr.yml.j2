name: Submit Provider to Upstream

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Provider domain to submit"
        required: true
        type: choice
        options:{% for p in all_providers %}
          - {{ p.domain }}{% endfor %}
      version:
        description: "Provider release version (e.g. 1.2.0)"
        required: true
        type: string
      reset_branch:
        description: "Reset branch to upstream/dev (discards manual commits on the branch)"
        required: false
        type: boolean
        default: false
      pr_summary:
        description: "Short title tagline (e.g. 'FLAC streaming, Lyrics, rich metadata'). Leave empty to use a generic title."
        required: false
        type: string
        default: ""

permissions:
  contents: write

jobs:
  create-upstream-pr:
    name: Create/update draft PR to upstream
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve domain and clone provider release
        env:
          GH_TOKEN: {% raw %}${{ secrets.FORK_SYNC_PAT }}{% endraw %}
        run: |
          case "{% raw %}${{ inputs.domain }}{% endraw %}" in{% for p in all_providers %}
            {{ p.domain }}) PROVIDER_REPO="{{ p.repo }}"; PROVIDER_PATH="{{ p.provider_path }}"; DISPLAY_NAME="{{ p.display_name }}" ;;{% endfor %}
            *) echo "Unknown domain: {% raw %}${{ inputs.domain }}{% endraw %}"; exit 1 ;;
          esac
          echo "PROVIDER_REPO=$PROVIDER_REPO" >> $GITHUB_ENV
          echo "PROVIDER_PATH=$PROVIDER_PATH" >> $GITHUB_ENV
          echo "DISPLAY_NAME=$DISPLAY_NAME" >> $GITHUB_ENV

          gh repo clone "$PROVIDER_REPO" provider-repo -- \
            --depth 1 --branch "v{% raw %}${{ inputs.version }}{% endraw %}"

          PREV_TAG=$(gh api "repos/${PROVIDER_REPO}/releases?per_page=2" \
            --jq '.[1].tag_name // ""' 2>/dev/null || echo "")
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      - name: Prepare upstream/<domain> branch and create/update draft PR
        env:
          GH_TOKEN: {% raw %}${{ secrets.FORK_SYNC_PAT }}{% endraw %}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git remote add upstream https://github.com/music-assistant/server.git
          git fetch upstream dev

          DOMAIN="{% raw %}${{ inputs.domain }}{% endraw %}"
          VERSION="v{% raw %}${{ inputs.version }}{% endraw %}"
          # Branch name has no version — one branch/PR per domain, updated on each run
          BRANCH="upstream/${DOMAIN}"

          BRANCH_EXISTS=$(git ls-remote --heads origin "$BRANCH" | grep -q . && echo "yes" || echo "no")

          if [[ "{% raw %}${{ inputs.reset_branch }}{% endraw %}" == "true" || "$BRANCH_EXISTS" == "no" ]]; then
            echo "Creating/resetting branch from upstream/dev"
            git checkout -B "$BRANCH" upstream/dev
            FORCE_PUSH="--force"
          else
            echo "Branch exists — updating provider files on top of existing commits"
            git checkout -B "$BRANCH" "origin/$BRANCH"
            FORCE_PUSH=""
          fi

          DEST="music_assistant/providers/${DOMAIN}"
          mkdir -p "$DEST"
          rsync -av --delete "provider-repo/${PROVIDER_PATH}" "$DEST/"

          if [ -d "provider-repo/tests" ]; then
            mkdir -p "tests/providers/${DOMAIN}"
            rsync -av --delete provider-repo/tests/ "tests/providers/${DOMAIN}/"
          fi

          git add -A
          if git diff --cached --quiet; then
            echo "No changes vs upstream/dev — nothing to submit"
            exit 0
          fi

          export PR_SUMMARY_INPUT="{% raw %}${{ inputs.pr_summary }}{% endraw %}"
          python3 - <<'PYEOF'
import os, json, subprocess

domain = os.environ['DOMAIN']
version = os.environ['VERSION']
provider_repo = os.environ['PROVIDER_REPO']
display_name = os.environ.get('DISPLAY_NAME', domain)
prev_tag = os.environ.get('PREV_TAG', '')
pr_summary = os.environ.get('PR_SUMMARY_INPUT', '').strip()

def gh_api(path):
    r = subprocess.run(['gh', 'api', path], capture_output=True, text=True)
    return json.loads(r.stdout) if r.returncode == 0 and r.stdout.strip() else None

what_new_lines, file_rows = [], []
compare_label = f'vs {prev_tag}' if prev_tag else 'initial'

if prev_tag:
    data = gh_api(f'repos/{provider_repo}/compare/{prev_tag}...{version}')
    if data:
        for c in data.get('commits', []):
            msg = c['commit']['message'].split('\n')[0]
            if msg.startswith(('feat:', 'fix:')):
                what_new_lines.append(f'- {msg}')
        for f in data.get('files', []):
            fn = f['filename']
            if fn.startswith('provider/') or fn.startswith('tests/'):
                file_rows.append(
                    f'| `{fn}` | {f["status"]} | +{f["additions"]}/-{f["deletions"]} |'
                )

if not what_new_lines:
    what_new_lines = ['_No feat/fix commits found_']

title = (
    f'feat({domain}): {version} — {pr_summary}'
    if pr_summary
    else f'feat({domain}): add {domain} provider {version}'
)

what_new = '\n'.join(what_new_lines)
files_section = (
    '| File | Status | Changes |\n|------|--------|---------|' +
    '\n' + '\n'.join(file_rows)
    if file_rows else '_No provider/tests files changed_'
)

body = f"""## {display_name} provider {version}

**Source**: [{provider_repo}](https://github.com/{provider_repo}) · tag [{version}](https://github.com/{provider_repo}/releases/tag/{version})

---

### What's new ({compare_label})

{what_new}

---

### Changed files ({compare_label})

{files_section}

---

> Draft PR — please review before requesting merge into upstream."""

with open('/tmp/pr_title.txt', 'w') as f:
    f.write(title)
with open('/tmp/pr_body.md', 'w') as f:
    f.write(body)

print(f'Title: {title}')
PYEOF

          PR_TITLE=$(cat /tmp/pr_title.txt)
          git commit -m "$PR_TITLE"
          git push origin "$BRANCH" $FORCE_PUSH

          PR_BODY=$(cat /tmp/pr_body.md)

          EXISTING_PR=$(gh pr list \
            --repo music-assistant/server \
            --head "trudenboy:${BRANCH}" \
            --json number --jq '.[0].number' 2>/dev/null || true)

          if [[ -n "$EXISTING_PR" ]]; then
            echo "PR #${EXISTING_PR} already exists — updating title and body"
            gh pr edit "$EXISTING_PR" \
              --repo music-assistant/server \
              --title "$PR_TITLE" \
              --body "$PR_BODY"
          else
            gh pr create \
              --draft \
              --repo music-assistant/server \
              --head "trudenboy:${BRANCH}" \
              --base dev \
              --title "$PR_TITLE" \
              --body "$PR_BODY"
          fi

  rebuild-integration:
    name: Rebuild integration/pending-upstream
    needs: create-upstream-pr
    uses: ./.github/workflows/rebuild-integration.yml
    secrets: inherit
