#!/usr/bin/env bash
# Auto-generated by ma-provider-tools â€” do not edit manually.
# Dev environment setup for the {{ domain }} provider.
set -euo pipefail

# Guard: require uv
if ! command -v uv &>/dev/null; then
  echo "ERROR: uv not found. Install: https://docs.astral.sh/uv/getting-started/installation/"
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
env_name="${1:-.venv}"

uv venv "$REPO_ROOT/$env_name"
source "$REPO_ROOT/$env_name/bin/activate"

{% if provider_type == 'music_provider' %}
# Install upstream MA server + provider in editable mode
uv pip install \
  "git+https://github.com/music-assistant/server.git@dev" \
  -e "$REPO_ROOT/.[test]"
{% else %}
# Clone fork MA server (player provider)
if [ ! -d "$REPO_ROOT/ma-server" ]; then
  git clone --depth=1 -b dev https://github.com/trudenboy/ma-server.git "$REPO_ROOT/ma-server"
fi
# Symlink provider into server
PROVIDER_TARGET="$REPO_ROOT/ma-server/music_assistant/providers/{{ domain }}"
rm -rf "$PROVIDER_TARGET"
ln -s "$REPO_ROOT/{{ provider_path }}" "$PROVIDER_TARGET"
cd "$REPO_ROOT/ma-server"
uv pip install -e "." -e ".[test]"
uv pip install -r requirements_all.txt
{% endif %}

# Set up pre-commit hooks if available
if command -v pre-commit &>/dev/null; then
  cd "$REPO_ROOT" && pre-commit install
fi

echo "Setup complete. Activate with: source $env_name/bin/activate"
