name: Auto-add issues to project

on:
  issues:
    types: [labeled]

permissions:
  issues: read

jobs:
  add-to-project:
    if: {% raw %}${{ startsWith(github.event.label.name, 'incident:') }}{% endraw %}
    runs-on: ubuntu-latest
    steps:
      - name: Add to MA Ecosystem project and set fields
        env:
          GH_TOKEN: {% raw %}${{ secrets.FORK_SYNC_PAT }}{% endraw %}
        run: |
          PID="PVT_kwHOCFMIf84BPvYe"
          IID="{% raw %}${{ github.event.issue.node_id }}{% endraw %}"
          LABEL="{% raw %}${{ github.event.label.name }}{% endraw %}"

          ITEM_ID=$(gh api graphql -f query='
            mutation($pid:ID!,$iid:ID!){
              addProjectV2ItemById(input:{projectId:$pid,contentId:$iid}){
                item{id}
              }
            }' \
            -f pid="$PID" \
            -f iid="$IID" \
            --jq '.data.addProjectV2ItemById.item.id')

          # Set Provider field
{% if domain == 'yandex_music' %}          PROVIDER_OPT="97d12d8f"
{% elif domain == 'kion_music' %}          PROVIDER_OPT="3b727476"
{% elif domain == 'zvuk_music' %}          PROVIDER_OPT="562dfe7b"
{% elif domain == 'msx_bridge' %}          PROVIDER_OPT="39fcac6d"
{% else %}          PROVIDER_OPT=""
{% endif %}
          if [[ -n "$PROVIDER_OPT" ]]; then
            gh api graphql -f query='
              mutation($pid:ID!,$iid:ID!,$fid:ID!,$oid:String!){
                updateProjectV2ItemFieldValue(input:{
                  projectId:$pid,itemId:$iid,
                  fieldId:$fid,
                  value:{singleSelectOptionId:$oid}
                }){projectV2Item{id}}
              }' \
              -f pid="$PID" \
              -f iid="$ITEM_ID" \
              -f fid="PVTSSF_lAHOCFMIf84BPvYezg-EBos" \
              -f oid="$PROVIDER_OPT"
          fi

          # Set Incident Type field based on label
          case "$LABEL" in
            "incident:ci")       INCIDENT_OPT="fa1d1581" ;;
            "incident:bug")      INCIDENT_OPT="7f0c15cb" ;;
            "incident:upstream") INCIDENT_OPT="91fd4f1b" ;;
            "incident:security") INCIDENT_OPT="70de5cac" ;;
            *)                   INCIDENT_OPT="" ;;
          esac

          if [[ -n "$INCIDENT_OPT" ]]; then
            gh api graphql -f query='
              mutation($pid:ID!,$iid:ID!,$fid:ID!,$oid:String!){
                updateProjectV2ItemFieldValue(input:{
                  projectId:$pid,itemId:$iid,
                  fieldId:$fid,
                  value:{singleSelectOptionId:$oid}
                }){projectV2Item{id}}
              }' \
              -f pid="$PID" \
              -f iid="$ITEM_ID" \
              -f fid="PVTSSF_lAHOCFMIf84BPvYezg-EBow" \
              -f oid="$INCIDENT_OPT"
          fi
