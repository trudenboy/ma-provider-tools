# Migrate All Providers to Thin Wrapper Workflows

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace standalone CI workflows in all 4 provider repos with thin wrappers that delegate to `ma-provider-tools` reusable workflows.

**Architecture:** `ma-provider-tools` holds the logic in `reusable-*.yml`. Provider repos hold only minimal `test.yml`, `release.yml`, `sync-to-fork.yml` generated from `wrappers/*.yml.j2` templates via `distribute.py`. After this migration, updating CI for all providers means touching only `ma-provider-tools`.

**Tech Stack:** Jinja2 (template rendering), GitHub Actions `workflow_call`, `gh` CLI, `distribute.py` script.

---

## Context

**Repos involved:**
- `/tmp/ma-provider-tools` — central tools repo (this is where we work)
- `/tmp/ma-providers/ma-provider-yandex-music` — music provider
- `/tmp/ma-providers/ma-provider-kion-music` — music provider
- `/tmp/ma-providers/ma-provider-zvuk-music` — music provider
- `/tmp/ma-providers/ma-provider-msx-bridge` — player provider

**Current state:** All 4 providers have identical standalone `test.yml/release.yml/sync-to-fork.yml` using the old `actions/setup-python + pip install uv` pattern. None call the reusable workflows from `ma-provider-tools`.

**After migration:** All providers will have thin wrappers (generated by `distribute.py`) that call the reusable workflows. `reusable-test.yml` already uses `astral-sh/setup-uv@v5` and has the correct player_provider/music_provider split.

**How distribution works:**
1. `distribute.py` reads `providers.yml` for the list of repos + their config
2. Renders `wrappers/*.yml.j2` with each provider's context
3. Creates a PR in each provider repo on branch `chore/update-workflow-wrappers`
4. `distribute.yml` GitHub Action triggers automatically on push to main when `providers.yml` or `wrappers/**` changes

**Key bug to fix first:** `providers.yml` has wrong paths for `msx_bridge`:
- `manifest_path: provider/msx_bridge/manifest.json` → should be `provider/manifest.json`
- `provider_path: provider/msx_bridge/` → should be `provider/`

(Files actually live at `provider/__init__.py`, `provider/manifest.json`, etc. — same flat structure as music providers.)

---

## Task 1: Fix msx_bridge paths in providers.yml

**Files:**
- Modify: `/tmp/ma-provider-tools/providers.yml`

**Step 1: Edit providers.yml**

Change the `msx_bridge` entry from:
```yaml
  - domain: msx_bridge
    repo: trudenboy/ma-provider-msx-bridge
    default_branch: dev
    manifest_path: provider/msx_bridge/manifest.json
    provider_path: provider/msx_bridge/
    provider_type: player_provider
    legacy_files:
      - .github/workflows/ci.yml
```

To:
```yaml
  - domain: msx_bridge
    repo: trudenboy/ma-provider-msx-bridge
    default_branch: dev
    manifest_path: provider/manifest.json
    provider_path: provider/
    provider_type: player_provider
    legacy_files:
      - .github/workflows/ci.yml
```

**Step 2: Verify dry-run output**

```bash
cd /tmp/ma-provider-tools
pip install jinja2 pyyaml -q
python3 scripts/distribute.py --dry-run
```

Expected output — 4 providers processed, each showing 3 "Updated:" lines (test.yml, release.yml, sync-to-fork.yml):
```
Processing trudenboy/ma-provider-yandex-music (yandex_music)
  Updated: .github/workflows/sync-to-fork.yml
  Updated: .github/workflows/release.yml
  Updated: .github/workflows/test.yml
...
Processing trudenboy/ma-provider-msx-bridge (msx_bridge)
  Updated: .github/workflows/sync-to-fork.yml
  Updated: .github/workflows/release.yml
  Updated: .github/workflows/test.yml
```

**Step 3: Verify rendered content for each provider type**

Run this to see what each provider's test.yml will look like:
```bash
python3 - <<'EOF'
import yaml
from jinja2 import Environment, FileSystemLoader, StrictUndefined
from pathlib import Path

root = Path("/tmp/ma-provider-tools")
env = Environment(loader=FileSystemLoader(str(root / "wrappers")), undefined=StrictUndefined, keep_trailing_newline=True)
registry = yaml.safe_load((root / "providers.yml").read_text())

for p in registry["providers"]:
    rendered = env.get_template("test.yml.j2").render(
        domain=p["domain"], manifest_path=p["manifest_path"],
        provider_path=p["provider_path"], provider_type=p["provider_type"]
    )
    print(f"\n{'='*40}\n{p['domain']} ({p['provider_type']})\n{'='*40}")
    print(rendered)
EOF
```

Check that:
- Music providers (`music_provider`): `provider_type: music_provider`, `provider_path: provider/`
- msx_bridge (`player_provider`): `provider_type: player_provider`, `provider_path: provider/`

**Step 4: Commit and push**

```bash
cd /tmp/ma-provider-tools
git add providers.yml
git commit -m "fix(providers): correct msx_bridge manifest and provider paths"
git push origin main
```

This push triggers `distribute.yml` automatically (it watches `providers.yml` changes).

---

## Task 2: Monitor distribute.yml and review PRs

**Step 1: Check the distribute.yml run**

```bash
gh run list --repo trudenboy/ma-provider-tools --workflow distribute.yml --limit 5
```

Wait ~2 minutes, then:
```bash
gh run watch --repo trudenboy/ma-provider-tools
```

Or watch via: https://github.com/trudenboy/ma-provider-tools/actions/workflows/distribute.yml

**Step 2: Verify PRs were created in all 4 provider repos**

```bash
for repo in trudenboy/ma-provider-yandex-music trudenboy/ma-provider-kion-music trudenboy/ma-provider-zvuk-music trudenboy/ma-provider-msx-bridge; do
  echo "=== $repo ==="
  gh pr list --repo "$repo" --head chore/update-workflow-wrappers
done
```

**Step 3: Review test.yml in yandex-music PR (music provider representative)**

The PR's test.yml should look like:
```yaml
name: Test
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    uses: trudenboy/ma-provider-tools/.github/workflows/reusable-test.yml@main
    with:
      provider_type: music_provider
      provider_domain: yandex_music
      provider_path: provider/
```

**Step 4: Review test.yml in msx-bridge PR (player provider)**

The PR's test.yml should look like:
```yaml
name: Test
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    uses: trudenboy/ma-provider-tools/.github/workflows/reusable-test.yml@main
    with:
      provider_type: player_provider
      provider_domain: msx_bridge
      provider_path: provider/
```

Also verify the msx-bridge PR does NOT include `ci.yml` (it should be deleted as a legacy file, but `ci.yml` doesn't actually exist in the repo anymore, so this is a no-op).

---

## Task 3: Merge PRs in all provider repos

**Step 1: Merge music provider PRs**

```bash
for repo in trudenboy/ma-provider-yandex-music trudenboy/ma-provider-kion-music trudenboy/ma-provider-zvuk-music; do
  pr_num=$(gh pr list --repo "$repo" --head chore/update-workflow-wrappers --json number -q '.[0].number')
  if [[ -n "$pr_num" ]]; then
    gh pr merge "$pr_num" --repo "$repo" --squash --delete-branch
    echo "Merged $repo PR #$pr_num"
  else
    echo "No PR found for $repo"
  fi
done
```

**Step 2: Merge msx-bridge PR**

```bash
pr_num=$(gh pr list --repo trudenboy/ma-provider-msx-bridge --head chore/update-workflow-wrappers --json number -q '.[0].number')
gh pr merge "$pr_num" --repo trudenboy/ma-provider-msx-bridge --squash --delete-branch
echo "Merged msx-bridge PR #$pr_num"
```

**Step 3: Verify final state**

```bash
for repo in trudenboy/ma-provider-yandex-music trudenboy/ma-provider-kion-music trudenboy/ma-provider-zvuk-music trudenboy/ma-provider-msx-bridge; do
  echo "=== $repo ==="
  gh api "repos/$repo/contents/.github/workflows/test.yml" -q '.content' | base64 -d | head -20
  echo ""
done
```

Confirm each repo's test.yml now shows `uses: trudenboy/ma-provider-tools/.github/workflows/reusable-test.yml@main`.

---

## Verification Summary

After all merges:
1. **All 4 providers**: `test.yml` is a thin wrapper → music providers run `lint-music-provider` + `test-music-provider` jobs; msx-bridge runs `lint-player-provider` + `test-player-provider` jobs
2. **msx-bridge specifically**: uses player_provider path (clone ma-server, symlink `provider/` into `music_assistant/providers/msx_bridge`, run tests with coverage)
3. **Future CI changes**: touch only `ma-provider-tools` — push to main auto-distributes to all providers via `distribute.yml`
4. **`providers.yml` msx_bridge paths**: `manifest_path: provider/manifest.json`, `provider_path: provider/`
